name: Retail Pricing ETL

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */12 * * *"

permissions:
  contents: read

concurrency:
  group: retail-etl-${{ github.ref }}
  cancel-in-progress: false

jobs:
  etl:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    concurrency:
      group: retail-pricing-etl
      cancel-in-progress: false

    env:
      # Secrets set in: Repo → Settings → Secrets and variables → Actions
      AZURE_STORAGE_CONNECTION_STRING: ${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}
      RAW_CONTAINER: retail-data
      RAW_PREFIX: raw
      SILVER_CONTAINER: retail-data
      SILVER_PREFIX: silver
      CONSUMER_ID: ${{ secrets.CONSUMER_ID }}
      KEY_VERSION: ${{ secrets.KEY_VERSION }}
      WALMART_SECRET: ${{ secrets.WALMART_SECRET }}
      EBAY_CLIENT_ID: ${{ secrets.EBAY_CLIENT_ID }}
      EBAY_CLIENT_SECRET: ${{ secrets.EBAY_CLIENT_SECRET }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # Optional: quick sanity check that critical env vars are present
      - name: Sanity check secrets
        run: |
          python - << 'PY'
          import os, sys
          for k in [
            "AZURE_STORAGE_CONNECTION_STRING",
            "CONSUMER_ID","KEY_VERSION","WALMART_SECRET",
            "EBAY_CLIENT_ID","EBAY_CLIENT_SECRET"
          ]:
              if not os.getenv(k):
                  print(f"Missing secret: {k}")
                  sys.exit(1)
          print("All required secrets present.")
          PY

      - name: Run ETL
        run: |
          python etl_script.py

